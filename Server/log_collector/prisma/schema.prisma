generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model RawLog {
  id               Int      @id @default(autoincrement())
  transaction_id   String   @unique
  timestamp        DateTime @map("timestamp")
  remote_host      String?  @map("remote_host")
  remote_port      Int?     @map("remote_port")
  local_host       String?  @map("local_host")
  local_port       Int?     @map("local_port")
  method           String?  @map("method")
  uri              String?  @map("uri")
  http_version     String?  @map("http_version")
  host             String?  @map("host")
  user_agent       String?  @map("user_agent")
  request_headers  Json?    @map("request_headers")
  request_body     String?  @map("request_body")
  response_headers Json?    @map("response_headers")
  response_body    String?  @map("response_body")
  matched_rules    Json?    @map("matched_rules")
  audit_summary    Json?    @map("audit_summary")
  full_log         Json     @map("full_log")
  created_at       DateTime @default(now()) @map("created_at")
  sessionId        Int?     @map("sessionId")
  session          Session? @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("RawLog")
}

model Session {
  // ✅ [수정] autoincrecrement() -> autoincrement() 오타 수정
  id               Int               @id @default(autoincrement())
  session_id       String            @unique @map("session_id")
  ip_address       String?           @map("ip_address")
  user_agent       String?           @map("user_agent")
  start_time       DateTime          @map("start_time")
  end_time         DateTime          @map("end_time")
  created_at       DateTime          @default(now()) @map("created_at")
  label            sessionLabel?
  confidence       confidenceLevel?
  classifier_raw   String?
  classification   String?           @map("classification")
  rawLogs          RawLog[]

  @@index([label], map: "idx_session_label")
  @@index([classification], map: "idx_session_classification")
  @@map("Session")
}

model Rule {
  id               Int        @id @default(autoincrement())
  rule_id          Int        @unique
  created_at       DateTime   @default(now())
  rule_name        String
  target           String
  operator         String
  phase            Int
  action           String
  transformation   String?
  severity_level   String
  logdata          String?
  rule_template    Json
  status           RuleStatus @default(Processing)

  @@index([created_at(sort: Desc)], map: "idx_rule_created_at")
  @@index([phase], map: "idx_rule_phase")
  @@index([severity_level], map: "idx_rule_severity")
  @@index([action], map: "idx_rule_action")
  @@index([created_at(sort: Desc), id(sort: Desc)], map: "idx_rule_created_at_id")
  @@index([status], name: "idx_rule_status")
  @@map("Rule")
}

enum sessionLabel {
  NORMAL
  MALICIOUS
  SQL_INJECTION
  CODE_INJECTION
  PATH_TRAVERSAL

  @@map("SessionLabel")
}

enum confidenceLevel {
  HIGH
  LOW

  @@map("ConfidenceLevel")
}

enum RuleStatus {
  Accepted
  Rejected
  Processing
}